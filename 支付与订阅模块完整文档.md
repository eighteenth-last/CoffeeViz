# CoffeeViz æ”¯ä»˜ä¸è®¢é˜…æ¨¡å—å®Œæ•´æ–‡æ¡£

## ğŸ“¦ æ¨¡å—æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº† CoffeeViz é¡¹ç›®çš„æ”¯ä»˜ä¸è®¢é˜…ç³»ç»Ÿï¼ŒåŒ…æ‹¬ä¸¤ä¸ªæ ¸å¿ƒæ¨¡å—ï¼š

1. **coffeeviz-payment** - ç‹¬ç«‹çš„æ”¯ä»˜å¤„ç†æ¨¡å—
2. **è®¢é˜…ç®¡ç†** - é›†æˆåœ¨ coffeeviz-service ä¸­çš„è®¢é˜…å’Œé…é¢ç®¡ç†

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ¨¡å—ä¾èµ–å…³ç³»

```
coffeeviz-web
    â”œâ”€â”€ coffeeviz-service (è®¢é˜…ã€é…é¢ç®¡ç†)
    â””â”€â”€ coffeeviz-payment (æ”¯ä»˜å¤„ç†)
```

### æ ¸å¿ƒç»„ä»¶

#### 1. æ”¯ä»˜æ¨¡å— (coffeeviz-payment)

```
coffeeviz-payment/
â”œâ”€â”€ enums/
â”‚   â”œâ”€â”€ PaymentMethod.java      # æ”¯ä»˜æ–¹å¼æšä¸¾
â”‚   â””â”€â”€ PaymentStatus.java      # æ”¯ä»˜çŠ¶æ€æšä¸¾
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ PaymentRequest.java     # æ”¯ä»˜è¯·æ±‚
â”‚   â”œâ”€â”€ PaymentResponse.java    # æ”¯ä»˜å“åº”
â”‚   â”œâ”€â”€ RefundRequest.java      # é€€æ¬¾è¯·æ±‚
â”‚   â””â”€â”€ RefundResponse.java     # é€€æ¬¾å“åº”
â”œâ”€â”€ config/
â”‚   â””â”€â”€ PaymentConfig.java      # æ”¯ä»˜é…ç½®
â”œâ”€â”€ handler/
â”‚   â”œâ”€â”€ PaymentHandler.java     # æ”¯ä»˜å¤„ç†å™¨æ¥å£
â”‚   â”œâ”€â”€ WechatPaymentHandler.java   # å¾®ä¿¡æ”¯ä»˜
â”‚   â”œâ”€â”€ AlipayPaymentHandler.java   # æ”¯ä»˜å®
â”‚   â””â”€â”€ StripePaymentHandler.java   # Stripe
â””â”€â”€ service/
    â”œâ”€â”€ PaymentService.java
    â””â”€â”€ impl/
        â””â”€â”€ PaymentServiceImpl.java
```

#### 2. è®¢é˜…æ¨¡å— (coffeeviz-service)

```
coffeeviz-service/
â”œâ”€â”€ entity/
â”‚   â”œâ”€â”€ SubscriptionPlan.java       # è®¢é˜…è®¡åˆ’
â”‚   â”œâ”€â”€ UserSubscription.java       # ç”¨æˆ·è®¢é˜…
â”‚   â”œâ”€â”€ PaymentOrder.java           # æ”¯ä»˜è®¢å•
â”‚   â””â”€â”€ UsageQuota.java             # ä½¿ç”¨é…é¢
â”œâ”€â”€ mapper/
â”‚   â”œâ”€â”€ SubscriptionPlanMapper.java
â”‚   â”œâ”€â”€ UserSubscriptionMapper.java
â”‚   â”œâ”€â”€ PaymentOrderMapper.java
â”‚   â””â”€â”€ UsageQuotaMapper.java
â””â”€â”€ service/
    â”œâ”€â”€ SubscriptionService.java    # è®¢é˜…æœåŠ¡
    â”œâ”€â”€ PaymentOrderService.java    # è®¢å•æœåŠ¡
    â”œâ”€â”€ QuotaService.java           # é…é¢æœåŠ¡
    â””â”€â”€ impl/
        â”œâ”€â”€ SubscriptionServiceImpl.java
        â”œâ”€â”€ PaymentOrderServiceImpl.java
        â””â”€â”€ QuotaServiceImpl.java
```

#### 3. Web å±‚ (coffeeviz-web)

```
coffeeviz-web/
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ PaymentController.java      # æ”¯ä»˜æ¥å£
â”‚   â””â”€â”€ SubscriptionController.java # è®¢é˜…æ¥å£
â”œâ”€â”€ dto/
â”‚   â””â”€â”€ CreatePaymentRequest.java   # åˆ›å»ºæ”¯ä»˜è¯·æ±‚
â”œâ”€â”€ annotation/
â”‚   â”œâ”€â”€ RequireSubscription.java    # è®¢é˜…æƒé™æ³¨è§£
â”‚   â””â”€â”€ RequireQuota.java           # é…é¢æ£€æŸ¥æ³¨è§£
â””â”€â”€ aspect/
    â”œâ”€â”€ SubscriptionAspect.java     # è®¢é˜…æƒé™åˆ‡é¢
    â””â”€â”€ QuotaAspect.java            # é…é¢æ£€æŸ¥åˆ‡é¢
```

## ğŸ’¾ æ•°æ®åº“è®¾è®¡

### 1. è®¢é˜…è®¡åˆ’è¡¨ (biz_subscription_plan)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| plan_code | varchar(50) | è®¡åˆ’ä»£ç  (FREE/PRO/TEAM) |
| plan_name | varchar(100) | è®¡åˆ’åç§° |
| price_monthly | decimal(10,2) | æœˆä»˜ä»·æ ¼ |
| price_yearly | decimal(10,2) | å¹´ä»˜ä»·æ ¼ |
| max_repositories | int | æœ€å¤§ä»“åº“æ•° (-1=æ— é™) |
| max_diagrams_per_repo | int | æ¯ä»“åº“æœ€å¤§å›¾è¡¨æ•° |
| support_jdbc | tinyint | æ˜¯å¦æ”¯æŒ JDBC |
| support_ai | tinyint | æ˜¯å¦æ”¯æŒ AI |
| support_export | tinyint | æ˜¯å¦æ”¯æŒå¯¼å‡º |
| support_team | tinyint | æ˜¯å¦æ”¯æŒå›¢é˜Ÿ |

### 2. ç”¨æˆ·è®¢é˜…è¡¨ (biz_user_subscription)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| user_id | bigint | ç”¨æˆ·ID |
| plan_id | bigint | è®¡åˆ’ID |
| billing_cycle | varchar(20) | è®¡è´¹å‘¨æœŸ (monthly/yearly) |
| start_time | datetime | å¼€å§‹æ—¶é—´ |
| end_time | datetime | ç»“æŸæ—¶é—´ |
| status | varchar(20) | çŠ¶æ€ (active/expired/cancelled) |
| auto_renew | tinyint | æ˜¯å¦è‡ªåŠ¨ç»­è´¹ |

### 3. æ”¯ä»˜è®¢å•è¡¨ (biz_payment_order)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| order_no | varchar(50) | è®¢å•å· |
| user_id | bigint | ç”¨æˆ·ID |
| subscription_id | bigint | è®¢é˜…ID |
| amount | decimal(10,2) | é‡‘é¢ |
| payment_method | varchar(50) | æ”¯ä»˜æ–¹å¼ |
| payment_status | varchar(20) | æ”¯ä»˜çŠ¶æ€ |
| transaction_id | varchar(100) | ç¬¬ä¸‰æ–¹äº¤æ˜“ID |

### 4. ä½¿ç”¨é…é¢è¡¨ (biz_usage_quota)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | bigint | ä¸»é”® |
| user_id | bigint | ç”¨æˆ·ID |
| quota_type | varchar(50) | é…é¢ç±»å‹ |
| quota_limit | int | é…é¢é™åˆ¶ |
| quota_used | int | å·²ä½¿ç”¨é…é¢ |
| reset_cycle | varchar(20) | é‡ç½®å‘¨æœŸ |

## ğŸ”Œ API æ¥å£

### æ”¯ä»˜æ¥å£

```http
# åˆ›å»ºæ”¯ä»˜è®¢å•
POST /api/payment/create
Content-Type: application/json

{
  "planId": 2,
  "billingCycle": "monthly",
  "paymentMethod": "wechat"
}

# æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
GET /api/payment/query/{orderNo}

# è·å–ç”¨æˆ·è®¢å•åˆ—è¡¨
GET /api/payment/orders

# æ”¯ä»˜å›è°ƒ
POST /api/payment/callback/wechat
POST /api/payment/callback/alipay
POST /api/payment/callback/stripe
```

### è®¢é˜…æ¥å£

```http
# è·å–æ‰€æœ‰è®¢é˜…è®¡åˆ’
GET /api/subscription/plans

# è·å–å½“å‰ç”¨æˆ·è®¢é˜…
GET /api/subscription/current

# å–æ¶ˆè®¢é˜…
POST /api/subscription/cancel?reason=ä¸éœ€è¦äº†

# æ£€æŸ¥åŠŸèƒ½æƒé™
GET /api/subscription/check-feature?feature=ai
```

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### 1. åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨æƒé™æ³¨è§£

```java
@RestController
@RequestMapping("/api/repository")
public class RepositoryController {
    
    // éœ€è¦è®¢é˜…ä¸”æ£€æŸ¥é…é¢
    @PostMapping("/create")
    @RequireSubscription
    @RequireQuota("repository")
    public Result<Repository> createRepository(@RequestBody CreateRequest request) {
        // åˆ›å»ºä»“åº“é€»è¾‘
        return Result.success(repository);
    }
    
    // éœ€è¦ JDBC åŠŸèƒ½
    @PostMapping("/connect")
    @RequireSubscription(feature = "jdbc")
    public Result<Void> connectDatabase(@RequestBody ConnectRequest request) {
        // è¿æ¥æ•°æ®åº“é€»è¾‘
        return Result.success();
    }
    
    // éœ€è¦ AI åŠŸèƒ½å’Œé…é¢
    @PostMapping("/ai-generate")
    @RequireSubscription(feature = "ai")
    @RequireQuota("ai_generate")
    public Result<String> aiGenerate(@RequestBody GenerateRequest request) {
        // AI ç”Ÿæˆé€»è¾‘
        return Result.success(result);
    }
}
```

### 2. åˆ›å»ºæ”¯ä»˜è®¢å•æµç¨‹

```java
// 1. ç”¨æˆ·é€‰æ‹©è®¢é˜…è®¡åˆ’
Long planId = 2; // PRO è®¡åˆ’
String billingCycle = "monthly"; // æœˆä»˜

// 2. åˆ›å»ºæ”¯ä»˜è®¢å•
CreatePaymentRequest request = new CreatePaymentRequest();
request.setPlanId(planId);
request.setBillingCycle(billingCycle);
request.setPaymentMethod("wechat");

// 3. è°ƒç”¨æ”¯ä»˜æ¥å£
PaymentResponse response = paymentController.createPayment(request);

// 4. è¿”å›æ”¯ä»˜äºŒç»´ç æˆ–è·³è½¬é“¾æ¥
String qrCode = response.getQrCode(); // å¾®ä¿¡æ”¯ä»˜äºŒç»´ç 
String paymentUrl = response.getPaymentUrl(); // æ”¯ä»˜å®/Stripe è·³è½¬é“¾æ¥
```

### 3. å¤„ç†æ”¯ä»˜å›è°ƒ

```java
// æ”¯ä»˜æˆåŠŸåï¼Œç³»ç»Ÿè‡ªåŠ¨ï¼š
// 1. éªŒè¯å›è°ƒç­¾å
// 2. æ›´æ–°è®¢å•çŠ¶æ€ä¸º paid
// 3. åˆ›å»ºæˆ–å‡çº§ç”¨æˆ·è®¢é˜…
// 4. åˆå§‹åŒ–æˆ–æ›´æ–°ç”¨æˆ·é…é¢
```

## âš™ï¸ é…ç½®è¯´æ˜

### application-dev.yml

```yaml
# æ”¯ä»˜é…ç½®
payment:
  wechat:
    app-id: ${WECHAT_APP_ID:}
    mch-id: ${WECHAT_MCH_ID:}
    api-key: ${WECHAT_API_KEY:}
    cert-path: ${WECHAT_CERT_PATH:}
    notify-url: ${APP_BASE_URL:http://localhost:8080}/api/payment/callback/wechat
  alipay:
    app-id: ${ALIPAY_APP_ID:}
    private-key: ${ALIPAY_PRIVATE_KEY:}
    public-key: ${ALIPAY_PUBLIC_KEY:}
    notify-url: ${APP_BASE_URL:http://localhost:8080}/api/payment/callback/alipay
    return-url: ${APP_BASE_URL:http://localhost:8080}/payment/success
  stripe:
    api-key: ${STRIPE_API_KEY:}
    webhook-secret: ${STRIPE_WEBHOOK_SECRET:}
    success-url: ${APP_BASE_URL:http://localhost:8080}/payment/success
    cancel-url: ${APP_BASE_URL:http://localhost:8080}/payment/cancel
```

### ç¯å¢ƒå˜é‡

```bash
# å¾®ä¿¡æ”¯ä»˜
export WECHAT_APP_ID=your_app_id
export WECHAT_MCH_ID=your_mch_id
export WECHAT_API_KEY=your_api_key
export WECHAT_CERT_PATH=/path/to/cert.p12

# æ”¯ä»˜å®
export ALIPAY_APP_ID=your_app_id
export ALIPAY_PRIVATE_KEY=your_private_key
export ALIPAY_PUBLIC_KEY=your_public_key

# Stripe
export STRIPE_API_KEY=sk_test_xxx
export STRIPE_WEBHOOK_SECRET=whsec_xxx

# åº”ç”¨åŸºç¡€ URL
export APP_BASE_URL=https://your-domain.com
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. æ•°æ®åº“åˆå§‹åŒ–

```bash
mysql -u root -p coffeeviz < coffeeviz-web/src/main/resources/subscription_tables.sql
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è®¾ç½®ä¸Šè¿°ç¯å¢ƒå˜é‡ã€‚

### 3. æ„å»ºé¡¹ç›®

```bash
mvn clean package -DskipTests
```

### 4. å¯åŠ¨åº”ç”¨

```bash
java -jar coffeeviz-web/target/coffeeviz-web-1.0.0-SNAPSHOT.jar
```

## ğŸ“‹ è®¢é˜…è®¡åˆ’è¯´æ˜

### FREE (ç¤¾åŒºç‰ˆ)
- ä»·æ ¼ï¼šå…è´¹
- æœ€å¤š 3 ä¸ªæ¶æ„é¡¹ç›®
- åŸºç¡€ SQL å¯¼å…¥ (MySQL Only)
- åŸºç¡€ ER å›¾ç”Ÿæˆ
- æœ¬åœ°å›¾ç‰‡å­˜å‚¨

### PRO (ä¸“ä¸šç‰ˆ)
- ä»·æ ¼ï¼šÂ¥29/æœˆ æˆ– Â¥290/å¹´
- æ— é™é¡¹ç›®æ•°é‡
- å¤šæ–¹è¨€ SQL æ”¯æŒ (PG, Oracle)
- å®æ—¶æ•°æ®åº“è¿æ¥åŒæ­¥
- AI æ™ºèƒ½è¾…åŠ©å»ºæ¨¡
- å¯¼å‡ºé«˜æ¸… SVG/PNG

### TEAM (å›¢é˜Ÿç‰ˆ)
- ä»·æ ¼ï¼šÂ¥99/æœˆ æˆ– Â¥990/å¹´
- åŒ…å«æ‰€æœ‰ä¸“ä¸šç‰ˆåŠŸèƒ½
- å›¢é˜Ÿåä½œæƒé™ç®¡ç†
- ç‰ˆæœ¬æ§åˆ¶ä¸å®¡è®¡
- API è‡ªåŠ¨åŒ–é›†æˆ
- 7x24 ä¼˜å…ˆæŠ€æœ¯æ”¯æŒ

## ğŸ”’ å®‰å…¨æœºåˆ¶

### 1. ç­¾åéªŒè¯
- æ‰€æœ‰æ”¯ä»˜å›è°ƒå¿…é¡»éªŒè¯ç­¾å
- é˜²æ­¢ä¼ªé€ å›è°ƒæ”»å‡»

### 2. å¹‚ç­‰æ€§
- è®¢å•å·å”¯ä¸€æ€§ä¿è¯
- é‡å¤å›è°ƒè‡ªåŠ¨è¯†åˆ«

### 3. çŠ¶æ€æœº
- è®¢å•çŠ¶æ€ä¸¥æ ¼æµè½¬
- é˜²æ­¢çŠ¶æ€å¼‚å¸¸

### 4. æƒé™æ§åˆ¶
- AOP åˆ‡é¢æ‹¦æˆª
- æ³¨è§£é©±åŠ¨æƒé™æ£€æŸ¥

## ğŸ“Š é…é¢ç±»å‹

| é…é¢ç±»å‹ | è¯´æ˜ | é‡ç½®å‘¨æœŸ |
|---------|------|---------|
| repository | ä»“åº“æ•°é‡ | never |
| diagram | å›¾è¡¨æ•°é‡ | monthly |
| sql_parse | SQL è§£ææ¬¡æ•° | daily |
| ai_generate | AI ç”Ÿæˆæ¬¡æ•° | monthly |

## ğŸ”§ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„æ”¯ä»˜æ–¹å¼

1. åˆ›å»º Handler å®ç° `PaymentHandler` æ¥å£
2. åœ¨ `PaymentServiceImpl` ä¸­æ³¨å†Œ
3. æ·»åŠ é…ç½®ç±»

```java
@Component
public class NewPaymentHandler implements PaymentHandler {
    @Override
    public PaymentResponse createPayment(PaymentRequest request) {
        // å®ç°æ”¯ä»˜é€»è¾‘
    }
    // ... å…¶ä»–æ–¹æ³•
}
```

### æ·»åŠ æ–°çš„è®¢é˜…è®¡åˆ’

ç›´æ¥åœ¨æ•°æ®åº“ä¸­æ’å…¥æ–°çš„è®¢é˜…è®¡åˆ’è®°å½•ï¼š

```sql
INSERT INTO biz_subscription_plan (
    plan_code, plan_name, price_monthly, price_yearly,
    max_repositories, support_jdbc, support_ai
) VALUES (
    'ENTERPRISE', 'ä¼ä¸šç‰ˆ', 299.00, 2990.00,
    -1, 1, 1
);
```

### æ·»åŠ æ–°çš„é…é¢ç±»å‹

åœ¨ `QuotaServiceImpl.initUserQuota()` ä¸­æ·»åŠ ï¼š

```java
createQuotaIfNotExists(userId, "new_quota_type", 100, "monthly");
```

## âœ… å·²å®ŒæˆåŠŸèƒ½

- âœ… æ”¯ä»˜æ¨¡å—ç‹¬ç«‹å°è£…
- âœ… å¤šæ”¯ä»˜æ–¹å¼æ”¯æŒ (å¾®ä¿¡/æ”¯ä»˜å®/Stripe)
- âœ… è®¢é˜…è®¡åˆ’ç®¡ç†
- âœ… ç”¨æˆ·è®¢é˜…ç®¡ç†
- âœ… é…é¢ç®¡ç†ç³»ç»Ÿ
- âœ… æƒé™æ³¨è§£å’Œ AOP æ‹¦æˆª
- âœ… æ”¯ä»˜è®¢å•ç®¡ç†
- âœ… æ•°æ®åº“è¡¨è®¾è®¡
- âœ… API æ¥å£å®ç°
- âœ… é…ç½®æ–‡ä»¶æ¨¡æ¿

## ğŸ”œ å¾…å®Œå–„åŠŸèƒ½

- â³ æ”¯ä»˜ SDK é›†æˆ (éœ€è¦çœŸå®å¯†é’¥)
- â³ æ”¯ä»˜å›è°ƒç­¾åéªŒè¯
- â³ è‡ªåŠ¨ç»­è´¹åŠŸèƒ½
- â³ è®¢é˜…åˆ°æœŸæé†’
- â³ é…é¢é¢„è­¦æœºåˆ¶
- â³ æ”¯ä»˜æ•°æ®ç»Ÿè®¡
- â³ é£æ§ç³»ç»Ÿ

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³» CoffeeViz æŠ€æœ¯å›¢é˜Ÿã€‚
