# æ”¯ä»˜æ¨¡å—æ¶æ„è®¾è®¡

## ğŸ“¦ æ¨¡å—ç»“æ„

```
coffeeviz-payment/
â”œâ”€â”€ src/main/java/com/coffeeviz/payment/
â”‚   â”œâ”€â”€ config/              # é…ç½®ç±»
â”‚   â”‚   â”œâ”€â”€ WechatPayConfig.java
â”‚   â”‚   â”œâ”€â”€ AlipayConfig.java
â”‚   â”‚   â””â”€â”€ StripeConfig.java
â”‚   â”œâ”€â”€ enums/               # æšä¸¾ç±»
â”‚   â”‚   â”œâ”€â”€ PaymentMethod.java    âœ… å·²åˆ›å»º
â”‚   â”‚   â””â”€â”€ PaymentStatus.java    âœ… å·²åˆ›å»º
â”‚   â”œâ”€â”€ model/               # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ PaymentRequest.java   âœ… å·²åˆ›å»º
â”‚   â”‚   â”œâ”€â”€ PaymentResponse.java
â”‚   â”‚   â”œâ”€â”€ RefundRequest.java
â”‚   â”‚   â””â”€â”€ PaymentNotify.java
â”‚   â”œâ”€â”€ service/             # æœåŠ¡æ¥å£
â”‚   â”‚   â”œâ”€â”€ PaymentService.java
â”‚   â”‚   â”œâ”€â”€ WechatPayService.java
â”‚   â”‚   â”œâ”€â”€ AlipayService.java
â”‚   â”‚   â””â”€â”€ StripePayService.java
â”‚   â”œâ”€â”€ handler/             # æ”¯ä»˜å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ PaymentHandler.java
â”‚   â”‚   â”œâ”€â”€ WechatPayHandler.java
â”‚   â”‚   â”œâ”€â”€ AlipayHandler.java
â”‚   â”‚   â””â”€â”€ StripePayHandler.java
â”‚   â””â”€â”€ exception/           # å¼‚å¸¸ç±»
â”‚       â””â”€â”€ PaymentException.java
â””â”€â”€ pom.xml                  âœ… å·²åˆ›å»º
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. ç»Ÿä¸€æ”¯ä»˜æ¥å£
```java
public interface PaymentService {
    // åˆ›å»ºæ”¯ä»˜
    PaymentResponse createPayment(PaymentRequest request);
    
    // æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
    PaymentResponse queryPayment(String orderNo);
    
    // å–æ¶ˆæ”¯ä»˜
    boolean cancelPayment(String orderNo);
    
    // é€€æ¬¾
    boolean refund(RefundRequest request);
    
    // å¤„ç†æ”¯ä»˜å›è°ƒ
    boolean handleNotify(PaymentNotify notify);
}
```

### 2. æ”¯ä»˜æ–¹å¼æ”¯æŒ

#### å¾®ä¿¡æ”¯ä»˜
- Native æ‰«ç æ”¯ä»˜
- JSAPI å…¬ä¼—å·/å°ç¨‹åºæ”¯ä»˜
- H5 æ”¯ä»˜
- APP æ”¯ä»˜

#### æ”¯ä»˜å®
- ç”µè„‘ç½‘ç«™æ”¯ä»˜
- æ‰‹æœºç½‘ç«™æ”¯ä»˜
- APP æ”¯ä»˜
- æ‰«ç æ”¯ä»˜

#### Stripe
- ä¿¡ç”¨å¡æ”¯ä»˜
- æ”¯æŒå›½é™…æ”¯ä»˜
- è®¢é˜…æ”¯ä»˜

### 3. æ”¯ä»˜æµç¨‹

```
ç”¨æˆ·é€‰æ‹©è®¢é˜…è®¡åˆ’
    â†“
åˆ›å»ºæ”¯ä»˜è®¢å•
    â†“
é€‰æ‹©æ”¯ä»˜æ–¹å¼
    â†“
è°ƒç”¨æ”¯ä»˜æ¥å£
    â†“
è¿”å›æ”¯ä»˜å‚æ•°ï¼ˆäºŒç»´ç /è·³è½¬é“¾æ¥ï¼‰
    â†“
ç”¨æˆ·å®Œæˆæ”¯ä»˜
    â†“
æ¥æ”¶æ”¯ä»˜å›è°ƒ
    â†“
éªŒè¯ç­¾å
    â†“
æ›´æ–°è®¢å•çŠ¶æ€
    â†“
æ¿€æ´»è®¢é˜…
```

## ğŸ“ é…ç½®è¯´æ˜

### application.yml
```yaml
# æ”¯ä»˜é…ç½®
payment:
  # å¾®ä¿¡æ”¯ä»˜
  wechat:
    app-id: ${WECHAT_APP_ID}
    mch-id: ${WECHAT_MCH_ID}
    api-v3-key: ${WECHAT_API_V3_KEY}
    private-key-path: ${WECHAT_PRIVATE_KEY_PATH}
    merchant-serial-number: ${WECHAT_SERIAL_NUMBER}
    notify-url: ${BASE_URL}/api/payment/notify/wechat
    
  # æ”¯ä»˜å®
  alipay:
    app-id: ${ALIPAY_APP_ID}
    private-key: ${ALIPAY_PRIVATE_KEY}
    public-key: ${ALIPAY_PUBLIC_KEY}
    gateway-url: https://openapi.alipay.com/gateway.do
    notify-url: ${BASE_URL}/api/payment/notify/alipay
    return-url: ${FRONTEND_URL}/payment/result
    
  # Stripe
  stripe:
    api-key: ${STRIPE_API_KEY}
    webhook-secret: ${STRIPE_WEBHOOK_SECRET}
    success-url: ${FRONTEND_URL}/payment/success
    cancel-url: ${FRONTEND_URL}/payment/cancel
```

## ğŸ” å®‰å…¨æªæ–½

### 1. ç­¾åéªŒè¯
- æ‰€æœ‰æ”¯ä»˜å›è°ƒå¿…é¡»éªŒè¯ç­¾å
- é˜²æ­¢ä¼ªé€ å›è°ƒæ”»å‡»

### 2. å¹‚ç­‰æ€§
- ä½¿ç”¨è®¢å•å·ä½œä¸ºå”¯ä¸€æ ‡è¯†
- é˜²æ­¢é‡å¤æ”¯ä»˜

### 3. é‡‘é¢æ ¡éªŒ
- å›è°ƒæ—¶éªŒè¯é‡‘é¢æ˜¯å¦åŒ¹é…
- é˜²æ­¢é‡‘é¢ç¯¡æ”¹

### 4. çŠ¶æ€æœº
```
PENDING â†’ PROCESSING â†’ PAID
   â†“           â†“
CANCELLED   FAILED
   
PAID â†’ REFUNDED
```

## ğŸ“Š æ•°æ®åº“è¡¨

### biz_payment_order (å·²åˆ›å»º)
- å­˜å‚¨æ”¯ä»˜è®¢å•ä¿¡æ¯
- è®°å½•æ”¯ä»˜çŠ¶æ€å˜æ›´

### biz_payment_log (æ–°å¢)
```sql
CREATE TABLE `biz_payment_log` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `order_no` varchar(50) NOT NULL,
  `action` varchar(50) NOT NULL COMMENT 'æ“ä½œç±»å‹',
  `request_data` text COMMENT 'è¯·æ±‚æ•°æ®',
  `response_data` text COMMENT 'å“åº”æ•°æ®',
  `status` varchar(20) COMMENT 'çŠ¶æ€',
  `error_msg` text COMMENT 'é”™è¯¯ä¿¡æ¯',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  INDEX `idx_order_no`(`order_no`)
) COMMENT='æ”¯ä»˜æ—¥å¿—è¡¨';
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºæ”¯ä»˜
```java
PaymentRequest request = new PaymentRequest();
request.setOrderNo("ORDER_" + System.currentTimeMillis());
request.setSubject("CoffeeViz ä¸“ä¸šç‰ˆè®¢é˜…");
request.setAmount(new BigDecimal("29.00"));
request.setPaymentMethod("wechat");
request.setUserId(userId);

PaymentResponse response = paymentService.createPayment(request);
// response.getQrCode() - å¾®ä¿¡æ”¯ä»˜äºŒç»´ç 
// response.getPayUrl() - æ”¯ä»˜å®è·³è½¬é“¾æ¥
```

### å¤„ç†å›è°ƒ
```java
@PostMapping("/notify/wechat")
public String handleWechatNotify(@RequestBody String notifyData) {
    boolean success = paymentService.handleNotify(notifyData);
    if (success) {
        return "SUCCESS";
    }
    return "FAIL";
}
```

## ğŸ“¦ ä¾èµ–å…³ç³»

```
coffeeviz-web
    â†“ depends on
coffeeviz-service
    â†“ depends on
coffeeviz-payment  â† æ–°æ¨¡å—
    â†“ depends on
coffeeviz-common
```

## âœ… å·²å®Œæˆ

1. âœ… åˆ›å»º pom.xml
2. âœ… åˆ›å»ºæšä¸¾ç±»ï¼ˆPaymentMethod, PaymentStatusï¼‰
3. âœ… åˆ›å»ºæ•°æ®æ¨¡å‹ï¼ˆPaymentRequestï¼‰

## ğŸ“‹ å¾…å®Œæˆ

1. â³ åˆ›å»ºé…ç½®ç±»ï¼ˆWechatPayConfig, AlipayConfig, StripeConfigï¼‰
2. â³ åˆ›å»ºæœåŠ¡æ¥å£å’Œå®ç°
3. â³ åˆ›å»ºæ”¯ä»˜å¤„ç†å™¨
4. â³ åˆ›å»ºå¼‚å¸¸ç±»
5. â³ åˆ›å»ºæ”¯ä»˜å›è°ƒå¤„ç†
6. â³ é›†æˆåˆ° service æ¨¡å—
7. â³ åˆ›å»º Controller
8. â³ ç¼–å†™å•å…ƒæµ‹è¯•

## ğŸ”„ ä¸‹ä¸€æ­¥

å‘Šè¯‰æˆ‘ä½ æƒ³ï¼š
1. ç»§ç»­å®Œæˆæ”¯ä»˜æ¨¡å—çš„æ ¸å¿ƒä»£ç ï¼Ÿ
2. å…ˆé…ç½®æ”¯ä»˜å¹³å°ï¼ˆå¾®ä¿¡/æ”¯ä»˜å®/Stripeï¼‰ï¼Ÿ
3. è¿˜æ˜¯å…ˆå®ç°æŸä¸ªç‰¹å®šçš„æ”¯ä»˜æ–¹å¼ï¼Ÿ
